# Rotated & Nested Models: Black voter turnout data

```{r }
blackturnout <- read.csv("/Users/mfoster1/Dropbox/fr17to_swat/2021 Spring/polsci_methods/quantProblemSet/blackturnout.csv")

blackturnout <- blackturnout %>% 
  mutate(black.candidate = ifelse(candidate == 1, 
                                 yes = "Black candidate\nin election", "No Black candidate\nin election"), 
         .after = candidate) %>% 
  unite(candidate_district, c("state","district", "year"), sep = " ", remove = F) %>%
  rename(prcnt.black.turnout = turnout, black.candidate_num = candidate, prcnt.black.voters = CVAP) %>%
  mutate(prcnt.black.turnout = 100*prcnt.black.turnout, prcnt.black.voters = 100*prcnt.black.voters)
# blackturnout <- blackturnout %>% sample_n(30)
```

This dataset provides a classic example where the sign and statistical significance of one of the coefficients, whether a Black candidate runs in an election, flips between the full regression model and the nested model. The DiRA package provides a method to analyze and visualize the *joint* change reflected by the nested model that creates this sign flip. You will also be able to examine the rotated axes *within the full regression model* that produce the same coefficient as in the nested model for the effect of having a Black candidate.
 
Each row in this dataset represents an election in a Congressional district between 2006 and 2010. The regression will examine the percentage of the Black population that votes based on whether there is a Black candidate in the election and the percentage of the district that is Black. The regression results for this model are created using the stargazer.dira() command in the DiRA package. 

## Directional regression results


```{r, results = 'asis'}
model.names <-  c("lm_multiple",  "lm_y.predby.x1", "lm_y.predby.x1.w.resids")
dira_models <- models.dira(formula =prcnt.black.turnout~ black.candidate_num+prcnt.black.voters, data = blackturnout, 
               model.names = model.names)
stargazer.dira(formula =prcnt.black.turnout~ black.candidate_num+prcnt.black.voters, data = blackturnout, 
               model.names = model.names, print.direction = F, print.model.descriptions = F,
               type = type, 
               keep.stat = c("n","aic", "adj.rsq", "f"),
               star.cutoffs = c(0.05, 0.01, 0.001) ,
               covariate.labels = c("Black candidate", "% Black voters", 
                                    "residuals of % Black voters", "Constant" ) ,
               dep.var.caption = "% Black turnout", 
               column.sep.width = "5pt"
               )
```

**Model 1** shows that the estimated regression surface can be defined by

\begin{align*}
\hat{y} &= \hat{\beta}_1 x_1 + \hat{\beta}_2 x_2  +  \hat{\beta}_0\\
\text{estimated % Black turnout} = & -0.736 * \text{Black candidate}+ \\ 
                                &0.207 * \text{% Black voters} + 37.528. 
\end{align*}

There is a nonsignificant and negative relationship between having a Black candidate in an election and Black turnout, when the percent of the voters who are Black is held constant. On the other hand, there is a strong positive and significant relationship between the percent of a voters who are Black and the percent of the Black population that turns out, when having a Black candidate is held constant.

**Model 2** creates a nested model by omitting % Black voters. The resulting regression is
\begin{align*}
\text{estimated % Black turnout} = 6.164 * \text{Black candidate}+ 39.386.
\end{align*}

It shows a strong positive relationship between the Black turnout percentage and whether the candidate is Black. Specifically, a district with a Black candidate generally has a 6.16\% higher turnout among the Black voters. You will see that this is largely because most districts where a Black candidate runs have a large Black voting population, and large Black communities tend to have a high turnout rate. This creates a *joint change* where both the % of a district that is Black *and* having a Black candidate changes simulatenously. The 3D graphic below visualize this joint change.

**Model 3** is a rotated model that retains the joint change information from the nested model in Model 2, but adds back a variable that contains part of the information of the Black voting population. Specifically, it includes a variable that is the residuals of the regression. This defines a rotated version of the same regression surface defined by Model 1. 

\begin{align*}
\text{estimated % Black turnout} = &6.164* \text{Black candidate}+ \\
                                  & 0.207 *\text{residuals of % Black voters} + 39.386
\end{align*}


This results in a rotation of the original axes defined by the relationship between the explanatory variables. Since all information about $x_1$ and $x_2$ from the original model is retained,
  
  1. The regression surfaces and confidence intervals defined by Models 1 and 3 are identical except for the rotation. All rotated and nested models can be interpreted in the coordinate system used by the original model, which facilitates comparisons and interpretations. Therefore the DiRA package plots all rotated and nested models in the coordinate system used by the original model.
  2. The identical regression surfaces in Models 1 and 3 are reflected by the identical F-statistic and adjusted R squared values for Models 1 and 3.
  3. Any rotated model like Model 3 has more information than a nested model like Model 2, so it is usually more precise. This is the case here, where the standard error on Model 3's coefficient for Black candidate is slightly smaller than Model 2's. 

## 3D regression visualization

The image is created using the add_3d.directions() command in the DiRA package. It shows the marginal effect of each of the variables within the models above. 

  - **Model 1**, $y \sim x_1 + x_2$, is shown with regression surface and a confidence interval surface. The marginal effects are shown in <span style="color: crimson;">red</span> and <span style="color: orange;">orange</span> lines.
  - **Model 2**, $y \sim x_1$, shows a nested model, which only has one axis, shown in <span style="color: aqua; background-color: black">light blue</span> dashed line. 
  - **Model 3**, $y \sim x_1 + x_2 \text{residuals}$, uses the same information as Model 1, but rotates the axis system. The axes are represented by the <span style="color: blue;">dark blue</span> and <span style="color: deepskyblue;">blue</span> lines. Note that the direction of the $x_1$ axis is identical to the $x_1$ axis of Model 2, and therefore appears *under* the dashed light blue line representing the marginal effect of $x_1$ in Model 2. The direction of $x_2$'s residuals are identical to the direction of $x_2$ in the original model, and appear *under* the orange marginal effect for the original model. Note that the DiRA package always uses the axis system defined by the original regression models. Although the axes for $x_1$ and $x_2\text{residuals}$ are not orthogonal to each other when plotted in the $x_1$, $x_2$ axis system, the observations in the data are orthogonal to each other when the $x_1$, $x_2\text{residuals}$ axis system is used.

To interact with this visual:

  - Hover over points to see the district and year a given election occurred.
  - Click and drag on the graphic to rotate it.
  - Click on items in the legend to remove specific parts of the image; click on that item again to put it back.
  - To reset the image to its starting point, hover over the image and click on the house symbol at the top right.


```{r }
plot_ly( ) %>%
  add_markers(data = blackturnout, 
              x = ~black.candidate_num,
              y = ~prcnt.black.voters,
              z = ~prcnt.black.turnout,
              text = ~candidate_district,
              color = ~black.candidate,
              colors = c("black", "orange"),
              size = 1 ) %>% 
  add_3d.directions(formula = prcnt.black.turnout~ black.candidate_num +prcnt.black.voters, 
                   data = blackturnout, model.names = model.names) %>%
  layout( 
    title = "\nBlack Turnout by\n Black Voting Population & Black Candidate",
    scene = list(xaxis = list(title = 'Black candidate (0 = no, 1 = yes)'),
                 yaxis = list(title = '% Voters who are Black'),
                 zaxis = list(title = '% Black turnout of total Black voters')),
    legend = list(font = list(size = 8))
    )

# saveWidget(multiple_turnout, "index.html")
```

## 2D nested and rotated models

```{r fig.height= 4.5, fig.width = 7.5}

p <- plot_ly(data = blackturnout, 
        x = ~black.candidate_num,
        y = ~prcnt.black.voters,
        z = ~prcnt.black.turnout,
        text = ~candidate_district,
        color = ~black.candidate,
        colors = c("black", "orange") ) %>%
  add_markers( ) %>% 
  layout(
    title = "\nBlack Turnout by\n Black Voting Population & Black Candidate",
    scene = list(xaxis = list(title = 'Black candidate (0 = no, 1 = yes)'),
                 yaxis = list(title = '% Voters who are Black'),
                 zaxis = list(title = '% Black turnout of total Black voters')),
    legend = list(font = list(size = 8))
    ) 
p %>% add_2d.directions(model.names, titleX = F) %>%  
      add_annotations(
        text = 'x2 ~ x1', x = 0.85, y = 1, yref = "paper",
        xref = "paper", xanchor = "middle", yanchor = "top", showarrow = FALSE, font = list(size = 15)
      ) %>%
      add_annotations(
        text = 'Black candidate (0 = no, 1 = yes)', x = 0.5, y = .02, yref = "paper",
        xref = "paper", xanchor = "middle", yanchor = "top", showarrow = FALSE, font = list(size = 15)
      )


```



The 2D images are created using the add_2d.directions() command in the DiRA package. They focus on the nested model from Model 2 and the rotated model from Model 3. You can (and should!) spin the 3D graphic to reflect the 2D images. The images are not identical because the 3D image has a perspective shift, but you can see that the 2D images are simply crossections of the 3D graphic. 

Tips to improve the view:

  - Focus on the blue lines in the 3D graphic by removing the red and orange lines (click on the corresponding items in the legend).
  - Click and drag from the top of the 3D plot to the bottom to see the top of the regression surface.
  - Hover over individual scatterpoints in any of these images to see which state, district, and year the elections occured in, and match the points in the 3D and 2D plots by the specific election they represent.

The right hand 2D image shows the best fit line between the percent of the voters who are Black and whether a Black candidate is in the election. The equation for this line is

\begin{align*}
\text{% Black voters} = 33.27* \text{Black candidate} + 8.96.
\end{align*}

An election with a Black candidate has, on average, 33.27\% more Black voters than an election without a Black candidate.

You now have enough information to fully interpret the joint direction shown in by the dark blue and light blue lines. Specifically, the joint effect of moving 

  - FROM an election *without* a Black candidate
  - TO an election *with* a Black candidate that also has 33.27\% more Black voters 

results in a 6.16\% increase in Black turnout. This joint change in $x_1$ and $x_2$ is associated with a statistically significant change in $y$ in both the rotated and nested models.

For any nested model $y \sim x_1$ of $y \sim x_1 + x_2$, a one unit change in $x_1$ is associated with a change in $x_2$ defined by the best fit line $x_2 \sim x_1$, and they jointly produce a change in $y$ defined by $y \sim x_1$.
